import{a as J,r as v,d as z,u as A,o as O,b as K,w as Q,c as Y,e as f,f as b,g as e,t as x,h as l,i as U,v as $,j as Z,k as ee,l as te,m as q,F as R,n as L,p as j,q as E}from"./index-CSr7E_KC.js";import{_ as le}from"./DeleteModal.vue_vue_type_script_setup_true_lang-DR-MbbGP.js";import{M as oe}from"./bootstrap.esm-C02OvDcj.js";const se="https://ec-course-api.hexschool.io/",V="yameow2025",P=J.create({baseURL:se});P.interceptors.request.use(o=>{const a=document.cookie.replace(/(?:(?:^|.*;\s*)hexToken\s*=\s*([^;]*).*$)|^.*$/,"$1");return a&&(o.headers.Authorization=a),o},o=>Promise.reject(o));P.interceptors.response.use(o=>Promise.resolve(o),o=>Promise.reject(o.response.data));const ae=o=>P.get(`/v2/api/${V}/admin/products`,{params:o}),ne=o=>P.post(`/v2/api/${V}/admin/product`,{data:o}),ie=o=>{const{data:a,id:g}=o;return P.put(`/v2/api/${V}/admin/product/${g}`,{data:a})},re=o=>P.delete(`/v2/api/${V}/admin/product/${o}`),de=async o=>P.post(`/v2/api/${V}/admin/upload`,o),F=4;function ue(o){try{const a=new URL(o);return["http:","https:"].includes(a.protocol)}catch{return!1}}async function ce(o){const a=new FormData;a.append("file-to-upload",o);try{return(await de(a)).data.imageUrl}catch(g){throw alert("上傳圖片失敗"),g}}function pe(o=[]){const a=v([...o]),g=v(""),c=v("未選擇檔案。"),p=v(null),d=v(!1);return{uploadedImages:a,imageUrlInput:g,fileNameDisplay:c,fileToUpload:p,isUploading:d,addImageUrl:()=>{const i=g.value.trim();if(i){if(a.value.length>=F){alert(`最多只能上傳 ${F} 張圖片`);return}if(!ue(i)){alert("請輸入有效的圖片 URL 格式 (需包含 http:// 或 https://)");return}a.value.push(i),g.value=""}},handleFileChange:i=>{const _=i.target,k=_.files?.[0];if(_.value="",!k){c.value="未選擇檔案。",p.value=null;return}if(!k.type.startsWith("image/")){alert("請選擇有效的圖片檔案！"),c.value="未選擇檔案。",p.value=null;return}if(a.value.length>=F){alert(`最多只能上傳 ${F} 張圖片！`),c.value="圖片數量已達上限，請先刪除圖片。",p.value=null;return}p.value=k,c.value=k.name},triggerUpload:async()=>{const i=p.value;if(!i){alert("請先選擇圖片檔案");return}if(!d.value)try{d.value=!0;const _=await ce(i);a.value.push(_),p.value=null,c.value="未選擇檔案。",alert("圖片上傳成功！")}catch(_){console.error("圖片上傳失敗:",_),alert("圖片上傳失敗，請稍後再試。")}finally{d.value=!1}},deleteImage:i=>{a.value.splice(i,1)},resetImages:(i=[])=>{a.value=[...i].filter(Boolean),g.value="",c.value="未選擇檔案。",p.value=null,d.value=!1}}}const G=()=>({id:"",title:"",origin_price:0,price:0,category:"",unit:"",num:0,content:"",description:"",is_enabled:1,imageUrl:"",imagesUrl:[""]});function me(){const o=v(G()),a=v("新增商品"),g=p=>{p?(o.value={...p},a.value="編輯商品"):c()},c=()=>{o.value=G(),a.value="新增商品"};return{form:o,formTitle:a,loadProduct:g,resetForm:c}}const ge={class:"modal-dialog modal-dialog-centered modal-lg"},fe={class:"modal-content rounded-lg"},be={class:"modal-header"},ve={class:"modal-title",id:"addNewProductModalLabel"},_e={class:"modal-body"},he={class:"row"},ye={class:"col-md-6"},Ue={class:"mb-3"},ke={class:"row"},$e={class:"col-6 mb-3"},xe={class:"col-6 mb-3"},we={class:"row"},Ce={class:"col-6 mb-3"},Pe={class:"col-6 mb-3"},Me={class:"mb-3"},Ie={class:"mb-3"},De={class:"mb-3 d-flex align-items-center"},Re={class:"form-check form-switch"},Ve={class:"col-md-6"},Fe={class:"mb-3"},je={class:"input-group mb-2"},Le=["disabled"],Ne={class:"input-group mb-2"},Te={class:"file-name-display form-control rounded-lg"},Se=["disabled"],Ae={key:0,class:"spinner-border spinner-border-sm me-1",role:"status","aria-hidden":"true"},Be={class:"mb-3"},Ee={id:"imagesContainer",class:"d-flex flex-wrap gap-2"},Ge=["src"],ze=["onClick"],Oe=["src"],qe={class:"modal-footer"},He=["disabled"],We=z({__name:"ProductModal",props:{product:{}},emits:["get-products"],setup(o,{expose:a,emit:g}){const c=g,p=A("modalRef");let d=null;O(()=>{p.value&&(d=new oe(p.value))}),K(()=>{d&&d.dispose()});const M=()=>{d&&d.show()},h=()=>{d&&d.hide()},{form:n,formTitle:I,loadProduct:w}=me(),{uploadedImages:i,imageUrlInput:_,fileToUpload:k,fileNameDisplay:m,isUploading:r,addImageUrl:u,triggerUpload:D,handleFileChange:B,deleteImage:H,resetImages:N}=pe();Q(()=>o.product,C=>{C.id?(w(C),N([C.imageUrl,...C.imagesUrl])):(w(null),N([]))},{immediate:!0,deep:!0});const W=Y(()=>!!o.product.id),T=v(!1),X=async()=>{const[C,...t]=i.value,{id:s,...y}=n.value;y.imageUrl=C,y.imagesUrl=t;const S={...y,imagesUrl:y.imagesUrl?y.imagesUrl:[""]};T.value=!0;try{W.value&&s?(await ie({data:S,id:s}),alert("編輯產品成功")):(await ne(S),alert("建立產品成功")),N([]),h()}catch{alert("新增/編輯產品失敗")}finally{T.value=!1,c("get-products")}};return a({openModal:M,closeModal:h}),(C,t)=>(b(),f("div",{ref_key:"modalRef",ref:p,class:"modal fade",id:"addNewProductModal",tabindex:"-1","aria-labelledby":"addNewProductModalLabel","aria-hidden":"true"},[e("div",ge,[e("div",fe,[e("div",be,[e("h5",ve,x(l(I)),1),e("button",{onClick:h,type:"button",class:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"})]),e("div",_e,[e("div",he,[e("div",ye,[e("form",null,[e("div",Ue,[t[12]||(t[12]=e("label",{for:"productName",class:"form-label"},"商品名稱",-1)),U(e("input",{"onUpdate:modelValue":t[0]||(t[0]=s=>l(n).title=s),type:"text",class:"form-control rounded-lg",id:"productName"},null,512),[[$,l(n).title]])]),e("div",ke,[e("div",$e,[t[13]||(t[13]=e("label",{for:"productOriginalPrice",class:"form-label"},"原價",-1)),U(e("input",{"onUpdate:modelValue":t[1]||(t[1]=s=>l(n).origin_price=s),type:"number",class:"form-control rounded-lg",id:"productOriginalPrice"},null,512),[[$,l(n).origin_price]])]),e("div",xe,[t[14]||(t[14]=e("label",{for:"productPrice",class:"form-label"},"售價",-1)),U(e("input",{"onUpdate:modelValue":t[2]||(t[2]=s=>l(n).price=s),type:"number",class:"form-control rounded-lg",id:"productPrice"},null,512),[[$,l(n).price]])])]),e("div",we,[e("div",Ce,[t[15]||(t[15]=e("label",{for:"productCategory",class:"form-label"},"分類",-1)),U(e("input",{"onUpdate:modelValue":t[3]||(t[3]=s=>l(n).category=s),class:"form-control rounded-lg",id:"productCategory"},null,512),[[$,l(n).category]])]),e("div",Pe,[t[16]||(t[16]=e("label",{for:"productUnit",class:"form-label"},"單位",-1)),U(e("input",{"onUpdate:modelValue":t[4]||(t[4]=s=>l(n).unit=s),class:"form-control rounded-lg",id:"productUnit"},null,512),[[$,l(n).unit]])])]),e("div",Me,[t[17]||(t[17]=e("label",{for:"productDescription",class:"form-label"},"商品內容",-1)),U(e("textarea",{"onUpdate:modelValue":t[5]||(t[5]=s=>l(n).content=s),class:"form-control rounded-lg",id:"productDescription",rows:"4"},null,512),[[$,l(n).content]])]),e("div",Ie,[t[18]||(t[18]=e("label",{for:"productDescription",class:"form-label"},"商品描述",-1)),U(e("textarea",{"onUpdate:modelValue":t[6]||(t[6]=s=>l(n).description=s),class:"form-control rounded-lg",id:"productDescription",rows:"4"},null,512),[[$,l(n).description]])]),e("div",De,[t[19]||(t[19]=e("label",{class:"form-label me-3 mb-0"},"啟用",-1)),e("div",Re,[U(e("input",{"onUpdate:modelValue":t[7]||(t[7]=s=>l(n).is_enabled=s),class:"form-check-input",type:"checkbox",id:"flexSwitchProductEnable","true-value":1,"false-value":0},null,512),[[Z,l(n).is_enabled]])])])])]),e("div",Ve,[e("div",Fe,[t[21]||(t[21]=e("label",{class:"form-label"},"上傳圖片 (最多 4 張)",-1)),e("div",je,[U(e("input",{type:"url",class:"form-control rounded-lg",placeholder:"輸入圖片連結","onUpdate:modelValue":t[8]||(t[8]=s=>ee(_)?_.value=s:null)},null,512),[[$,l(_)]]),e("button",{class:"btn btn-outline-secondary rounded-lg ms-2",type:"button",onClick:t[9]||(t[9]=(...s)=>l(u)&&l(u)(...s)),disabled:l(i).length>=4}," 新增連結 ",8,Le)]),e("div",Ne,[t[20]||(t[20]=e("label",{class:"input-group-text rounded-lg",for:"imageInputFile"},"瀏覽...",-1)),e("input",{onChange:t[10]||(t[10]=(...s)=>l(B)&&l(B)(...s)),type:"file",class:"form-control d-none",id:"imageInputFile",accept:".jpg, .jpeg, .png"},null,32),e("div",Te,x(l(m)),1),e("button",{onClick:t[11]||(t[11]=(...s)=>l(D)&&l(D)(...s)),disabled:!l(k)||l(r)||l(i).length>=4,class:"btn btn-outline-secondary rounded-lg ms-2",type:"button"},[l(r)?(b(),f("span",Ae)):te("",!0),q(" "+x(l(r)?"上傳中...":"上傳圖片"),1)],8,Se)])]),e("div",Be,[t[23]||(t[23]=e("div",{class:"d-flex justify-content-between align-items-center mb-2"},[e("label",{class:"form-label mb-0"},"已上傳圖片")],-1)),e("div",Ee,[(b(!0),f(R,null,L(l(i),(s,y)=>(b(),f("div",{key:y,class:j(["image-preview-thumbnail-container",{"main-image":y===0}])},[e("img",{src:s,class:"image-preview-thumbnail",alt:"商品圖片預覽"},null,8,Ge),e("button",{class:"btn btn-danger btn-sm delete-btn",onClick:S=>l(H)(y)},[...t[22]||(t[22]=[e("i",{class:"fas fa-times"},null,-1)])],8,ze)],2))),128)),(b(!0),f(R,null,L(4-l(i).length,s=>(b(),f("div",{key:"placeholder-"+s,class:"image-preview-thumbnail-container"},[e("img",{src:`https://placehold.co/100x100/e9ecef/adb5bd?text=Image+${l(i).length+s}`,class:"image-preview-thumbnail"},null,8,Oe)]))),128))])])])])]),e("div",qe,[e("button",{onClick:h,type:"button",class:"btn btn-outline-secondary rounded-lg"}," 取消 "),e("button",{onClick:X,disabled:T.value,type:"button",class:"btn btn-dark rounded-lg"}," 儲存 ",8,He)])])])],512))}}),Xe={class:"d-flex justify-content-end align-items-center mb-4"},Je={class:"card shadow-sm rounded-lg flex-grow-1"},Ke={class:"card-body p-4"},Qe={key:0,class:"table-responsive"},Ye={class:"table table-hover align-middle"},Ze={class:"text-center"},et={class:"form-check form-switch d-flex justify-content-center align-items-center"},tt=["checked"],lt={class:"text-nowrap"},ot=["onClick"],st=["onClick"],at={key:1,class:"d-flex justify-content-center align-items-center",style:{height:"calc(100vh - 98px)"}},nt={class:"d-flex justify-content-center mt-4"},it={class:"pagination"},rt={class:"page-item"},dt=["disabled"],ut=["onClick","disabled"],ct={class:"page-item"},pt=["disabled"],vt=z({__name:"ProductManagement",setup(o){const a=A("productModalRef"),g=A("deleteModalRef"),c=v("1"),p=v([]),d=v({total_pages:0,current_page:0,has_pre:!1,has_next:!1,category:""}),M=v(!1),h=async()=>{M.value=!0;try{const m=await ae({page:c.value});p.value=m.data.products,d.value=m.data.pagination}catch{alert("取得產品列表失敗")}finally{M.value=!1}},n=m=>{c.value=String(m),h()};O(()=>{h()});const I=()=>({id:"",title:"",origin_price:0,price:0,category:"",unit:"",num:0,content:"",description:"",is_enabled:1,imageUrl:"",imagesUrl:[""]}),w=v(I()),i=(m=null)=>{m?w.value={...m,imagesUrl:m.imagesUrl?[...m.imagesUrl]:[""]}:w.value=I(),a.value?.openModal()},_=m=>{g.value?.openModal(()=>k(m))},k=async m=>{try{await re(m),alert("刪除商品成功")}catch{alert("刪除商品失敗")}finally{h()}};return(m,r)=>(b(),f(R,null,[e("div",Xe,[e("button",{onClick:r[0]||(r[0]=u=>i(null)),type:"button",class:"btn btn-dark rounded-lg px-4 py-2"},[...r[3]||(r[3]=[e("i",{class:"fas fa-plus me-2"},null,-1),q("新增商品 ",-1)])])]),e("div",Je,[e("div",Ke,[M.value?(b(),f("div",at,[...r[5]||(r[5]=[e("div",{class:"spinner-border",role:"status"},[e("span",{class:"visually-hidden"},"Loading...")],-1)])])):(b(),f("div",Qe,[e("table",Ye,[r[4]||(r[4]=e("thead",null,[e("tr",null,[e("th",{scope:"col"},"分類"),e("th",{scope:"col"},"商品名稱"),e("th",{scope:"col"},"原價"),e("th",{scope:"col"},"售價"),e("th",{scope:"col",class:"text-center"},"啟用"),e("th",{scope:"col"})])],-1)),e("tbody",null,[(b(!0),f(R,null,L(p.value,u=>(b(),f("tr",{key:u.id},[e("td",null,x(u.category),1),e("td",null,x(u.title),1),e("td",null,x(u.origin_price),1),e("td",null,x(u.price),1),e("td",Ze,[e("div",et,[e("input",{readonly:"",class:"form-check-input",style:{"pointer-events":"none"},type:"checkbox",id:"flexSwitchCheckDefault1",checked:!!u.is_enabled},null,8,tt)])]),e("td",lt,[e("button",{onClick:D=>i(u),type:"button",class:"btn btn-sm btn-outline-dark rounded-lg me-2"}," 編輯 ",8,ot),e("button",{onClick:D=>_(u.id),type:"button",class:"btn btn-sm btn-outline-danger rounded-lg"}," 刪除 ",8,st)])]))),128))])])])),e("nav",nt,[e("ul",it,[e("li",rt,[e("button",{onClick:r[1]||(r[1]=u=>n(Number(c.value)-1)),disabled:!d.value?.has_pre,type:"button",class:j(["page-link",{disabled:!d.value?.has_pre}]),"aria-label":"Previous"},[...r[6]||(r[6]=[e("span",{"aria-hidden":"true"},"«",-1)])],10,dt)]),(b(!0),f(R,null,L(d.value?.total_pages,u=>(b(),f("li",{class:"page-item",key:u},[e("button",{onClick:D=>n(u),disabled:c.value===u.toString(),type:"button",class:j(["page-link",{active:c.value===u.toString()}])},x(u),11,ut)]))),128)),e("li",ct,[e("button",{onClick:r[2]||(r[2]=u=>n(Number(c.value)+1)),disabled:!d.value?.has_next,class:j(["page-link",{disabled:!d.value?.has_next}]),type:"button","aria-label":"Next"},[...r[7]||(r[7]=[e("span",{"aria-hidden":"true"},"»",-1)])],10,pt)])])])])]),E(We,{ref_key:"productModalRef",ref:a,product:w.value,onGetProducts:h},null,8,["product"]),E(le,{ref_key:"deleteModalRef",ref:g,title:"刪除商品",content:"確定要刪除該商品嗎？"},null,512)],64))}});export{vt as default};
