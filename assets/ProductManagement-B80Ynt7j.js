import{p as q,f as g,e as G,u as A,g as z,E as J,j as K,B as Q,c as v,o as h,a as e,t as P,x as l,z as U,A as x,G as Y,H as Z,s as ee,d as H,F as L,h as B,n as te,b as T}from"./index-C69pFwWw.js";import{M as le,_ as oe}from"./DeleteModal.vue_vue_type_script_setup_true_lang-C3CdSstr.js";import{L as se}from"./LayoutPagination-BnxaVBOU.js";const ae="https://ec-course-api.hexschool.io/",D="yameow2025",C=q.create({baseURL:ae});C.interceptors.request.use(o=>{const a=document.cookie.replace(/(?:(?:^|.*;\s*)hexToken\s*=\s*([^;]*).*$)|^.*$/,"$1");return a&&(o.headers.Authorization=a),o},o=>Promise.reject(o));C.interceptors.response.use(o=>Promise.resolve(o),o=>Promise.reject(o.response.data));const ne=o=>C.get(`/v2/api/${D}/admin/products`,{params:o}),ie=o=>C.post(`/v2/api/${D}/admin/product`,{data:o}),re=o=>{const{data:a,id:c}=o;return C.put(`/v2/api/${D}/admin/product/${c}`,{data:a})},de=o=>C.delete(`/v2/api/${D}/admin/product/${o}`),ce=async o=>C.post(`/v2/api/${D}/admin/upload`,o),V=4;function ue(o){try{const a=new URL(o);return["http:","https:"].includes(a.protocol)}catch{return!1}}async function pe(o){const a=new FormData;a.append("file-to-upload",o);try{return(await ce(a)).data.imageUrl}catch(c){throw alert("上傳圖片失敗"),c}}function me(o=[]){const a=g([...o]),c=g(""),p=g("未選擇檔案。"),r=g(null),u=g(!1);return{uploadedImages:a,imageUrlInput:c,fileNameDisplay:p,fileToUpload:r,isUploading:u,addImageUrl:()=>{const n=c.value.trim();if(n){if(a.value.length>=V){alert(`最多只能上傳 ${V} 張圖片`);return}if(!ue(n)){alert("請輸入有效的圖片 URL 格式 (需包含 http:// 或 https://)");return}a.value.push(n),c.value=""}},handleFileChange:n=>{const f=n.target,k=f.files?.[0];if(f.value="",!k){p.value="未選擇檔案。",r.value=null;return}if(!k.type.startsWith("image/")){alert("請選擇有效的圖片檔案！"),p.value="未選擇檔案。",r.value=null;return}if(a.value.length>=V){alert(`最多只能上傳 ${V} 張圖片！`),p.value="圖片數量已達上限，請先刪除圖片。",r.value=null;return}r.value=k,p.value=k.name},triggerUpload:async()=>{const n=r.value;if(!n){alert("請先選擇圖片檔案");return}if(!u.value)try{u.value=!0;const f=await pe(n);a.value.push(f),r.value=null,p.value="未選擇檔案。",alert("圖片上傳成功！")}catch(f){console.error("圖片上傳失敗:",f),alert("圖片上傳失敗，請稍後再試。")}finally{u.value=!1}},deleteImage:n=>{a.value.splice(n,1)},resetImages:(n=[])=>{a.value=[...n].filter(Boolean),c.value="",p.value="未選擇檔案。",r.value=null,u.value=!1}}}const S=()=>({id:"",title:"",origin_price:0,price:0,category:"",unit:"",num:0,content:"",description:"",is_enabled:1,imageUrl:"",imagesUrl:[""]});function ge(){const o=g(S()),a=g("新增商品"),c=r=>{r?(o.value={...r},a.value="編輯商品"):p()},p=()=>{o.value=S(),a.value="新增商品"};return{form:o,formTitle:a,loadProduct:c,resetForm:p}}const fe={class:"modal-dialog modal-dialog-centered modal-lg"},be={class:"modal-content rounded-lg"},ve={class:"modal-header"},he={class:"modal-title",id:"addNewProductModalLabel"},ye={class:"modal-body"},_e={class:"row"},Ue={class:"col-md-6"},ke={class:"mb-3"},xe={class:"row"},we={class:"col-6 mb-3"},$e={class:"col-6 mb-3"},Pe={class:"row"},Ce={class:"col-6 mb-3"},Me={class:"col-6 mb-3"},Ie={class:"mb-3"},De={class:"mb-3"},Re={class:"mb-3 d-flex align-items-center"},Ve={class:"form-check form-switch"},Le={class:"col-md-6"},Fe={class:"mb-3"},Ne={class:"input-group mb-2"},je=["disabled"],Te={class:"input-group mb-2"},Ae={class:"file-name-display form-control rounded-lg"},Be=["disabled"],Ee={key:0,class:"spinner-border spinner-border-sm me-1",role:"status","aria-hidden":"true"},Se={class:"mb-3"},Ge={id:"imagesContainer",class:"d-flex flex-wrap gap-2"},ze=["src"],He=["onClick"],Oe=["src"],We={class:"modal-footer"},Xe=["disabled"],qe=G({__name:"ProductModal",props:{product:{}},emits:["get-products"],setup(o,{expose:a,emit:c}){const p=c,r=A("modalRef");let u=null;z(()=>{r.value&&(u=new le(r.value))}),J(()=>{u&&u.dispose()});const M=()=>{u&&u.show()},y=()=>{u&&u.hide()},{form:i,formTitle:I,loadProduct:w}=ge(),{uploadedImages:n,imageUrlInput:f,fileToUpload:k,fileNameDisplay:d,isUploading:m,addImageUrl:b,triggerUpload:R,handleFileChange:E,deleteImage:O,resetImages:F}=me();K(()=>o.product,$=>{$.id?(w($),F([$.imageUrl,...$.imagesUrl])):(w(null),F([]))},{immediate:!0,deep:!0});const W=Q(()=>!!o.product.id),N=g(!1),X=async()=>{const[$,...t]=n.value,{id:s,..._}=i.value;_.imageUrl=$,_.imagesUrl=t;const j={..._,imagesUrl:_.imagesUrl?_.imagesUrl:[""]};N.value=!0;try{W.value&&s?(await re({data:j,id:s}),alert("編輯產品成功")):(await ie(j),alert("建立產品成功")),F([]),y()}catch{alert("新增/編輯產品失敗")}finally{N.value=!1,p("get-products")}};return a({openModal:M,closeModal:y}),($,t)=>(h(),v("div",{ref_key:"modalRef",ref:r,class:"modal fade",id:"addNewProductModal",tabindex:"-1","aria-labelledby":"addNewProductModalLabel","aria-hidden":"true"},[e("div",fe,[e("div",be,[e("div",ve,[e("h5",he,P(l(I)),1),e("button",{onClick:y,type:"button",class:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"})]),e("div",ye,[e("div",_e,[e("div",Ue,[e("form",null,[e("div",ke,[t[12]||(t[12]=e("label",{for:"productName",class:"form-label"},"商品名稱",-1)),U(e("input",{"onUpdate:modelValue":t[0]||(t[0]=s=>l(i).title=s),type:"text",class:"form-control rounded-lg",id:"productName"},null,512),[[x,l(i).title]])]),e("div",xe,[e("div",we,[t[13]||(t[13]=e("label",{for:"productOriginalPrice",class:"form-label"},"原價",-1)),U(e("input",{"onUpdate:modelValue":t[1]||(t[1]=s=>l(i).origin_price=s),type:"number",class:"form-control rounded-lg",id:"productOriginalPrice"},null,512),[[x,l(i).origin_price]])]),e("div",$e,[t[14]||(t[14]=e("label",{for:"productPrice",class:"form-label"},"售價",-1)),U(e("input",{"onUpdate:modelValue":t[2]||(t[2]=s=>l(i).price=s),type:"number",class:"form-control rounded-lg",id:"productPrice"},null,512),[[x,l(i).price]])])]),e("div",Pe,[e("div",Ce,[t[15]||(t[15]=e("label",{for:"productCategory",class:"form-label"},"分類",-1)),U(e("input",{"onUpdate:modelValue":t[3]||(t[3]=s=>l(i).category=s),class:"form-control rounded-lg",id:"productCategory"},null,512),[[x,l(i).category]])]),e("div",Me,[t[16]||(t[16]=e("label",{for:"productUnit",class:"form-label"},"單位",-1)),U(e("input",{"onUpdate:modelValue":t[4]||(t[4]=s=>l(i).unit=s),class:"form-control rounded-lg",id:"productUnit"},null,512),[[x,l(i).unit]])])]),e("div",Ie,[t[17]||(t[17]=e("label",{for:"productDescription",class:"form-label"},"商品內容",-1)),U(e("textarea",{"onUpdate:modelValue":t[5]||(t[5]=s=>l(i).content=s),class:"form-control rounded-lg",id:"productDescription",rows:"4"},null,512),[[x,l(i).content]])]),e("div",De,[t[18]||(t[18]=e("label",{for:"productDescription",class:"form-label"},"商品描述",-1)),U(e("textarea",{"onUpdate:modelValue":t[6]||(t[6]=s=>l(i).description=s),class:"form-control rounded-lg",id:"productDescription",rows:"4"},null,512),[[x,l(i).description]])]),e("div",Re,[t[19]||(t[19]=e("label",{class:"form-label me-3 mb-0"},"啟用",-1)),e("div",Ve,[U(e("input",{"onUpdate:modelValue":t[7]||(t[7]=s=>l(i).is_enabled=s),class:"form-check-input",type:"checkbox",id:"flexSwitchProductEnable","true-value":1,"false-value":0},null,512),[[Y,l(i).is_enabled]])])])])]),e("div",Le,[e("div",Fe,[t[21]||(t[21]=e("label",{class:"form-label"},"上傳圖片 (最多 4 張)",-1)),e("div",Ne,[U(e("input",{type:"url",class:"form-control rounded-lg",placeholder:"輸入圖片連結","onUpdate:modelValue":t[8]||(t[8]=s=>Z(f)?f.value=s:null)},null,512),[[x,l(f)]]),e("button",{class:"btn btn-outline-secondary rounded-lg ms-2",type:"button",onClick:t[9]||(t[9]=(...s)=>l(b)&&l(b)(...s)),disabled:l(n).length>=4}," 新增連結 ",8,je)]),e("div",Te,[t[20]||(t[20]=e("label",{class:"input-group-text rounded-lg",for:"imageInputFile"},"瀏覽...",-1)),e("input",{onChange:t[10]||(t[10]=(...s)=>l(E)&&l(E)(...s)),type:"file",class:"form-control d-none",id:"imageInputFile",accept:".jpg, .jpeg, .png"},null,32),e("div",Ae,P(l(d)),1),e("button",{onClick:t[11]||(t[11]=(...s)=>l(R)&&l(R)(...s)),disabled:!l(k)||l(m)||l(n).length>=4,class:"btn btn-outline-secondary rounded-lg ms-2",type:"button"},[l(m)?(h(),v("span",Ee)):ee("",!0),H(" "+P(l(m)?"上傳中...":"上傳圖片"),1)],8,Be)])]),e("div",Se,[t[23]||(t[23]=e("div",{class:"d-flex justify-content-between align-items-center mb-2"},[e("label",{class:"form-label mb-0"},"已上傳圖片")],-1)),e("div",Ge,[(h(!0),v(L,null,B(l(n),(s,_)=>(h(),v("div",{key:_,class:te(["image-preview-thumbnail-container",{"main-image":_===0}])},[e("img",{src:s,class:"image-preview-thumbnail",alt:"商品圖片預覽"},null,8,ze),e("button",{class:"btn btn-danger btn-sm delete-btn",onClick:j=>l(O)(_)},[...t[22]||(t[22]=[e("i",{class:"fas fa-times"},null,-1)])],8,He)],2))),128)),(h(!0),v(L,null,B(4-l(n).length,s=>(h(),v("div",{key:"placeholder-"+s,class:"image-preview-thumbnail-container"},[e("img",{src:`https://placehold.co/100x100/e9ecef/adb5bd?text=Image+${l(n).length+s}`,class:"image-preview-thumbnail"},null,8,Oe)]))),128))])])])])]),e("div",We,[e("button",{onClick:y,type:"button",class:"btn btn-outline-secondary rounded-lg"}," 取消 "),e("button",{onClick:X,disabled:N.value,type:"button",class:"btn btn-dark rounded-lg"}," 儲存 ",8,Xe)])])])],512))}}),Je={class:"d-flex justify-content-end align-items-center mb-4"},Ke={class:"card shadow-sm rounded-lg flex-grow-1"},Qe={class:"card-body p-4"},Ye={key:0,class:"table-responsive"},Ze={class:"table table-hover align-middle"},et={class:"text-center"},tt={class:"form-check form-switch d-flex justify-content-center align-items-center"},lt=["checked"],ot={class:"text-nowrap"},st=["onClick"],at=["onClick"],nt={key:1,class:"d-flex justify-content-center align-items-center",style:{height:"calc(100vh - 98px)"}},ut=G({__name:"ProductManagement",setup(o){const a=A("productModalRef"),c=A("deleteModalRef"),p=g("1"),r=g([]),u=g({total_pages:0,current_page:0,has_pre:!1,has_next:!1,category:""}),M=g(!1),y=async()=>{M.value=!0;try{const d=await ne({page:p.value});r.value=d.data.products,u.value=d.data.pagination}catch{alert("取得產品列表失敗")}finally{M.value=!1}},i=d=>{p.value=d,y()};z(()=>{y()});const I=()=>({id:"",title:"",origin_price:0,price:0,category:"",unit:"",num:0,content:"",description:"",is_enabled:1,imageUrl:"",imagesUrl:[""]}),w=g(I()),n=(d=null)=>{d?w.value={...d,imagesUrl:d.imagesUrl?[...d.imagesUrl]:[""]}:w.value=I(),a.value?.openModal()},f=d=>{c.value?.openModal(()=>k(d))},k=async d=>{try{await de(d),alert("刪除商品成功")}catch{alert("刪除商品失敗")}finally{y()}};return(d,m)=>(h(),v(L,null,[e("div",Je,[e("button",{onClick:m[0]||(m[0]=b=>n(null)),type:"button",class:"btn btn-dark rounded-lg px-4 py-2"},[...m[1]||(m[1]=[e("i",{class:"fas fa-plus me-2"},null,-1),H("新增商品 ",-1)])])]),e("div",Ke,[e("div",Qe,[M.value?(h(),v("div",nt,[...m[3]||(m[3]=[e("div",{class:"spinner-border",role:"status"},[e("span",{class:"visually-hidden"},"Loading...")],-1)])])):(h(),v("div",Ye,[e("table",Ze,[m[2]||(m[2]=e("thead",null,[e("tr",null,[e("th",{scope:"col"},"分類"),e("th",{scope:"col"},"商品名稱"),e("th",{scope:"col"},"原價"),e("th",{scope:"col"},"售價"),e("th",{scope:"col",class:"text-center"},"啟用"),e("th",{scope:"col"})])],-1)),e("tbody",null,[(h(!0),v(L,null,B(r.value,b=>(h(),v("tr",{key:b.id},[e("td",null,P(b.category),1),e("td",null,P(b.title),1),e("td",null,P(b.origin_price),1),e("td",null,P(b.price),1),e("td",et,[e("div",tt,[e("input",{readonly:"",class:"form-check-input",style:{"pointer-events":"none"},type:"checkbox",id:"flexSwitchCheckDefault1",checked:!!b.is_enabled},null,8,lt)])]),e("td",ot,[e("button",{onClick:R=>n(b),type:"button",class:"btn btn-sm btn-outline-dark rounded-lg me-2"}," 編輯 ",8,st),e("button",{onClick:R=>f(b.id),type:"button",class:"btn btn-sm btn-outline-danger rounded-lg"}," 刪除 ",8,at)])]))),128))])])])),T(se,{pagination:u.value,onHandlePagination:i},null,8,["pagination"])])]),T(qe,{ref_key:"productModalRef",ref:a,product:w.value,onGetProducts:y},null,8,["product"]),T(oe,{ref_key:"deleteModalRef",ref:c,title:"刪除商品",content:"確定要刪除該商品嗎？"},null,512)],64))}});export{ut as default};
