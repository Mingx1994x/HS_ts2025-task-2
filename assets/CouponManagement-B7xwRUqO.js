import{a as P,d as L,r as f,c as j,w as A,u as R,o as U,b as B,e as u,f as p,g as o,t as h,i as y,v as x,j as N,q as S,m as F,F as T,n as q}from"./index-CbuAa_38.js";import{M as G,_ as H}from"./DeleteModal.vue_vue_type_script_setup_true_lang-Dv_ejxbx.js";import{_ as I}from"./LayoutPagination.vue_vue_type_script_setup_true_lang-CTjNwurG.js";function z(){return document.cookie.replace(/(?:(?:^|.*;\s*)hexToken\s*=\s*([^;]*).*$)|^.*$/,"$1")}const W="https://ec-course-api.hexschool.io/",g=P.create({baseURL:W});g.interceptors.request.use(n=>{const i=z();return i&&(n.headers.Authorization=i),n},n=>Promise.reject(n));g.interceptors.response.use(n=>n,n=>Promise.reject(n.response.data));const M="yameow2025",Y=n=>g.post(`/v2/api/${M}/admin/coupon`,{data:n}),J=n=>{const{id:i,data:b}=n;return g.put(`/v2/api/${M}/admin/coupon/${i}`,{data:b})},K=n=>g.delete(`/v2/api/${M}/admin/coupon/${n}`),O=n=>g.get(`/v2/api/${M}/admin/coupons`,{params:n}),Q={class:"modal-dialog modal-dialog-centered modal-lg"},X={class:"modal-content rounded-lg"},Z={class:"modal-header"},ee={class:"modal-title",id:"couponModalLabel"},oe={class:"modal-body"},te={class:"mb-3"},ne={class:"mb-3"},le={class:"mb-3"},se={class:"mb-3"},ae={class:"mb-3 d-flex align-items-center"},de={class:"form-check form-switch"},ie={class:"modal-footer"},ce=L({__name:"CouponModal",props:{coupon:{},functionMode:{}},emits:["get-coupons"],setup(n,{expose:i,emit:b}){const c=n,l=f(c.coupon),m=j({get(){if(!l.value.due_date)return"";const s=new Date(l.value.due_date),e=s.getFullYear(),t=String(s.getMonth()+1).padStart(2,"0"),a=String(s.getDate()).padStart(2,"0");return`${e}-${t}-${a}`},set(s){if(!s){l.value.due_date=Date.now();return}const[e,t,a]=s.split("-").map(Number),_=new Date(e,t-1,a,0,0,0,0);l.value.due_date=_.getTime()}});A([()=>c.coupon,()=>c.functionMode],([s])=>{l.value={...s}});const w=b;let d=null;const r=R("modalRef"),D=()=>{d&&d.show()},k=()=>{d&&d.hide()};U(()=>{r.value&&(d=new G(r.value))}),B(()=>{d&&d.dispose()}),i({openModal:D,closeModal:k});const v=async s=>{try{const e=await Y(s);console.log("新增優惠券成功",e)}catch(e){console.error(e),alert("新增優惠券失敗，請稍後再試")}},$=async()=>{try{const{id:s,title:e,is_enabled:t,percent:a,due_date:_,code:V}=l.value,E=await J({id:s,data:{title:e,is_enabled:t,percent:a,due_date:_,code:V}});console.log("更新優惠券成功",E)}catch(s){console.error(s),alert("更新優惠券失敗，請稍後再試")}},C=async s=>{s==="create"?await v(l.value):await $(),k(),w("get-coupons")};return(s,e)=>(p(),u("div",{ref_key:"modalRef",ref:r,class:"modal fade",id:"couponModal",tabindex:"-1","aria-labelledby":"couponModalLabel","aria-hidden":"true"},[o("div",Q,[o("div",X,[o("div",Z,[o("h5",ee,h(c.functionMode==="create"?"新增優惠券":"編輯優惠券"),1),e[7]||(e[7]=o("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"},null,-1))]),o("div",oe,[o("form",null,[o("div",te,[e[8]||(e[8]=o("label",{for:"couponTitle",class:"form-label"},"優惠券標題",-1)),y(o("input",{type:"text",class:"form-control rounded-lg",id:"couponTitle",placeholder:"例如：新會員專屬折扣","onUpdate:modelValue":e[0]||(e[0]=t=>l.value.title=t)},null,512),[[x,l.value.title]])]),o("div",ne,[e[9]||(e[9]=o("label",{for:"couponCode",class:"form-label"},"優惠碼",-1)),y(o("input",{type:"text",class:"form-control rounded-lg",id:"couponCode",placeholder:"例如：NEW2024","onUpdate:modelValue":e[1]||(e[1]=t=>l.value.code=t)},null,512),[[x,l.value.code]])]),o("div",le,[e[10]||(e[10]=o("label",{for:"couponDiscount",class:"form-label"},"折扣",-1)),y(o("input",{type:"number",max:"100",min:"0",class:"form-control rounded-lg",id:"couponDiscount",placeholder:"例如：90 代表 9 折","onUpdate:modelValue":e[2]||(e[2]=t=>l.value.percent=t)},null,512),[[x,l.value.percent]])]),o("div",se,[e[11]||(e[11]=o("label",{for:"couponEndDate",class:"form-label"},"截止日",-1)),y(o("input",{type:"date",class:"form-control rounded-lg",id:"couponEndDate","onUpdate:modelValue":e[3]||(e[3]=t=>m.value=t)},null,512),[[x,m.value]])]),o("div",ae,[e[12]||(e[12]=o("label",{class:"form-label me-3 mb-0"},"啟用",-1)),o("div",de,[y(o("input",{class:"form-check-input",type:"checkbox",id:"flexSwitchCouponEnable","onUpdate:modelValue":e[4]||(e[4]=t=>l.value.is_enabled=t),"true-value":1,"false-value":0},null,512),[[N,l.value.is_enabled]])])])])]),o("div",ie,[e[13]||(e[13]=o("button",{type:"button",class:"btn btn-outline-secondary rounded-lg","data-bs-dismiss":"modal"}," 取消 ",-1)),c.functionMode==="create"?(p(),u("button",{key:0,type:"button",class:"btn btn-dark rounded-lg",onClick:e[5]||(e[5]=t=>C("create"))}," 新增 ")):(p(),u("button",{key:1,type:"button",class:"btn btn-dark rounded-lg",onClick:e[6]||(e[6]=t=>C("edit"))}," 儲存 "))])])])],512))}}),re={class:"d-flex justify-content-end align-items-center mb-4"},ue={class:"card shadow-sm rounded-lg flex-grow-1"},pe={class:"card-body p-4"},me={key:0,class:"table-responsive"},fe={class:"table table-hover align-middle"},be={class:"text-center"},ve={class:"form-check form-switch d-flex justify-content-center align-items-center"},ge=["checked"],_e={class:"text-nowrap"},ye=["onClick"],he=["onClick"],ke={key:1,class:"d-flex justify-content-center align-items-center",style:{height:"calc(100vh - 98px)"}},Me=L({__name:"CouponManagement",setup(n){const i=f([]),b=f("1"),c=f({total_pages:0,current_page:0,has_pre:!1,has_next:!1,category:""}),l=f(!1),m=async()=>{l.value=!0;try{const e=await O({page:b.value});console.log("取得優惠券成功",e),i.value=e.data.coupons,c.value=e.data.pagination}catch(e){console.error(e),alert("取得優惠券失敗，請稍後再試")}finally{l.value=!1}},w=e=>{b.value=e,m()};U(()=>{m()});const d=()=>({id:"",title:"",is_enabled:0,percent:0,due_date:new Date().getTime()+3600*24*1e3,code:"",num:0}),r=f(d()),D=R("couponModalRef"),k=R("couponDeleteModalRef"),v=f("create"),$=(e=null)=>{e?(r.value={...e},v.value="edit"):(r.value=d(),v.value="create"),console.log("應該要傳入的 coupon 資料",r.value),console.log("應該要傳入的 mode",v.value),D.value?.openModal()},C=e=>{k.value?.openModal(()=>s(e))},s=async e=>{try{await K(e)}catch(t){console.error(t),alert("刪除失敗，請稍後再試")}finally{m()}};return(e,t)=>(p(),u(T,null,[o("div",re,[o("button",{type:"button",class:"btn btn-dark rounded-lg px-4 py-2",onClick:t[0]||(t[0]=a=>$(null))},[...t[1]||(t[1]=[o("i",{class:"fas fa-plus me-2"},null,-1),F("新增優惠券 ",-1)])])]),o("div",ue,[o("div",pe,[l.value?(p(),u("div",ke,[...t[3]||(t[3]=[o("div",{class:"spinner-border",role:"status"},[o("span",{class:"visually-hidden"},"Loading...")],-1)])])):(p(),u("div",me,[o("table",fe,[t[2]||(t[2]=o("thead",null,[o("tr",null,[o("th",{scope:"col"},"優惠券名稱"),o("th",{scope:"col"},"優惠券碼"),o("th",{scope:"col"},"優惠折扣"),o("th",{scope:"col"},"到期日期"),o("th",{scope:"col",class:"text-center"},"啟用"),o("th",{scope:"col"})])],-1)),o("tbody",null,[(p(!0),u(T,null,q(i.value,a=>(p(),u("tr",{key:a.id},[o("td",null,h(a.title),1),o("td",null,h(a.code),1),o("td",null,h(`${a.percent}%`),1),o("td",null,h(new Date(a.due_date).toLocaleDateString()),1),o("td",be,[o("div",ve,[o("input",{readonly:"",class:"form-check-input",style:{"pointer-events":"none"},type:"checkbox",id:"flexSwitchCheckDefault1",checked:!!a.is_enabled},null,8,ge)])]),o("td",_e,[o("button",{type:"button",class:"btn btn-sm btn-outline-dark rounded-lg me-2",onClick:_=>$(a)}," 編輯 ",8,ye),o("button",{type:"button",class:"btn btn-sm btn-outline-danger rounded-lg",onClick:_=>C(a.id)}," 刪除 ",8,he)])]))),128))])])]))]),S(I,{pagination:c.value,onHandlePagination:w},null,8,["pagination"])]),S(ce,{ref:"couponModalRef",coupon:r.value,"function-mode":v.value,onGetCoupons:m},null,8,["coupon","function-mode"]),S(H,{ref:"couponDeleteModalRef",title:"刪除優惠券",content:"確定要刪除優惠券嗎？"},null,512)],64))}});export{Me as default};
